#!/bin/bash

set -o nounset
set -o errexit

# the internal mechanisms for installing and testing do not
# work if the checkout path is not named "oci_env", so
# this script should -always- abort if that is not the case.
CWD=$(basename $(pwd))
if [[ "${CWD}" != "oci_env" ]]; then
    cat >&2 <<EOF
ERROR: The checkout directory -must- be named oci_env. A different
       name can cause many unintended behaviors inside the containers
EOF
    exit 1
fi

if [[ -f '.compose.env' ]]; then
  # export variables from .compose.env but only if the var is not already set.
  eval "$(grep -v '^#' .compose.env | sed -E 's|^(.+)=(.*)$|export \1=${\1:-\2}|g' | xargs -L 1)"
fi

# if [[ -z "${COMPOSE_PROFILE:-}" ]]; then
#   cat >&2 <<EOF
# ERROR: The \$COMPOSE_PROFILE environment variable MUST be set.
#        The the easiest way to to this is to create a .compose.env file by running:

#            \$ cp .compose.env.example .compose.env
# EOF
#   exit 1
# fi

source ./config_loader.sh

echo "INFO: Using compose profile ${COMPOSE_PROFILE}" >&2
echo "INFO: ${DEV_SOURCE_PATH:-No} packages installed from source" >&2
echo "INFO: Image suffix ${DEV_IMAGE_SUFFIX:-is unset}" >&2
echo "INFO: Volume suffix ${DEV_VOLUME_SUFFIX:-${DEV_IMAGE_SUFFIX:-is unset}}" >&2

# profile loader
# separate profiles with :
# if profile has /, load from plugin/profiles
# else load from ./profiles
# add profile/{NAME}/compose.yaml to compose args
# concatenate profile/{NAME}/pulp_config.env into ./.combined.env

compose_args=(
  -f 'base/compose.yaml'
)

cat 'base/pulp_config.env' > '.combined.env'

echo '#!/bin/bash' > .init.sh
echo '' >> .init.sh
echo '# AUTOGENERATED by ./compose' >> .init.sh
echo '# This script runs automatically when the container starts.' >> .init.sh
echo '' >> .init.sh
echo 'bash /src/oci_env/base/init.sh' >> .init.sh

if [[ ! -z "${COMPOSE_PROFILE}" ]]; then
  IFS=':' read -ra src_path_list <<< "$COMPOSE_PROFILE"

  for item in "${src_path_list[@]}"; do
    compose_file="./profiles/${item}/compose.yaml"
    config_file="./profiles/${item}/pulp_config.env"
    init_script="../oci_env/profiles/${item}/init.sh"

    if [[ "$item" == *\/* ]]
    then
      profile=()
      IFS='/' read -ra profile <<< "$item"

      compose_file="../${profile[0]}/profiles/${profile[1]}/compose.yaml"
      config_file="../${profile[0]}/profiles/${profile[1]}/pulp_config.env"
      init_script="../${profile[0]}/profiles/${profile[1]}/init.sh"
    fi

    if [[ -f $compose_file ]]; then
      compose_args+=(
        -f $compose_file
      )
    fi

    if [[ -f $config_file ]]; then
      { echo "" & cat $config_file; } >> '.combined.env'
    fi

    if [[ -f $init_script ]]; then
      echo "bash ${init_script//\.\.//src}" >> '.init.sh'
    fi
  done
fi

# substitute variables allowed in env files
sed -i -e 's|${API_PORT}|'$API_PORT'|g' .combined.env
sed -i -e 's|${API_PROTOCOL}|'$API_PROTOCOL'|g' .combined.env
sed -i -e 's|${API_HOST}|'$API_HOST'|g' .combined.env

exec docker-compose "${compose_args[@]}" "$@"
